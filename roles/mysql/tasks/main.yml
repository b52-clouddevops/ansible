- name: Coping MySql Repo  
  ansible.builtin.copy:                    # Copies the file from the files directory
    src: "{{COMPONENT}}.repo"
    dest: /etc/yum.repos.d/{{COMPONENT}}.repo 

- name: Installing MySql 
  ansible.builtin.yum:
    name: 
       - mysql-community-server
       - MySQL-python
    state: present  

- name: Starting MySQL service 
  ansible.builtin.service:
    name: mysqld
    state: started
    enabled: true  

- name: Reading MySQL Log File 
  ansible.builtin.slurp:
      src: /var/log/mysqld.log 
  register: mysql_log 

- name: Declaring the fact in a variable 
  ansible.builtin.set_fact: 
     DEFAULT_PASS: "{{mysql_log['content'] | b64decode }}| regex_findall('temporary password.*') " 
        #  DEFAULT_PASS: "{{ mysql_log['content'] | b64decode | regex_findall('temporary password.*') | join(' ') }}" 

- name: Printing the output 
  debug:
    msg: "{{DEFAULT_PASS}}"

# - name: Connecting using default password  
#   block:
#     - name: Grep mysql version
#       community.mysql.mysql_info:
#         login_user: root
#         login_password: "{{DB_PASSWORD}}" 
#         filter: version
  
#   rescue: 
#     - name: Reading MySQL Log File 
#       ansible.builtin.slurp:
#          src: /var/log/mysqld.log 
#       register: mysql_log 
    






# Using set_fact, I will be preserving the output in  a variable 
# Block and rescue will work together; Rescue tasks will only be executed when the task in the block fail 

# - name: Reset password block 
#   when: MYSQL_STAT.failed
#   ignore_errors: yes 
#   block:
#     - name: Fetching Default Password                 # This task will be executed only when the status of failed is TRUE 
#       ansible.builtin.shell: grep "temporary password" /var/log/mysqld.log | awk '{print $NF}' 
#       register: DEFAULT_ROOT_PASSWORD  

#     - name: Coping MySql Repo  
#       ansible.builtin.copy:                    # Copies the file from the files directory
#         src: root-pass.sql
#         dest: /tmp/root-pass.sql  

#     - name: Reset Default Password               # This task will be executed only when the status of failed is TRUE 
#       ansible.builtin.shell: mysql --connect-expired-password -uroot -p"{{DEFAULT_ROOT_PASSWORD}}" < /tmp/root-pass.sql 
